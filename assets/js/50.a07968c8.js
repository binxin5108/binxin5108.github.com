(window.webpackJsonp=window.webpackJsonp||[]).push([[50],{541:function(t,a,s){"use strict";s.r(a);var i=s(22),e=Object(i.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("blockquote",[s("p",[t._v("本文介绍在使用 kubesphere 平台部署 Mysql、Redis 中间件")])]),t._v(" "),s("h2",{attrs:{id:"_1、应用部署需要关注的三要素"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1、应用部署需要关注的三要素"}},[t._v("#")]),t._v(" 1、应用部署需要关注的三要素")]),t._v(" "),s("ol",[s("li",[t._v("应用的部署方式：选择哪种工作负载？Deployment、Satefulset、DaemonSet？")]),t._v(" "),s("li",[t._v("应用的数据挂载：要挂载什么类型数据？卷、ConfigMap、Secret?")]),t._v(" "),s("li",[t._v("应用的可访问性：Service的暴露方式？ClusterIP、NodePort？")])]),t._v(" "),s("h2",{attrs:{id:"_2、部署mysql"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2、部署mysql"}},[t._v("#")]),t._v(" 2、部署Mysql")]),t._v(" "),s("h3",{attrs:{id:"_2-1、mysql-容器启动方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1、mysql-容器启动方式"}},[t._v("#")]),t._v(" 2.1、Mysql 容器启动方式")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run -p "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3306")]),t._v(":3306 --name mysql-01 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-v /mydata/mysql/log:/var/log/mysql "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-v /mydata/mysql/data:/var/lib/mysql "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-v /mydata/mysql/conf:/etc/mysql/conf.d "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-e "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_ROOT_PASSWORD")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("root "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--restart"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("always "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-d mysql:5.7 \n")])])]),s("p",[t._v("Mysql用来数据存储的，肯定选择有状态副本集（Statefulset）部署方式")]),t._v(" "),s("p",[t._v("为了容器宕掉我们的数据和配置还在，需要把 "),s("code",[t._v("/var/lib/mysql")]),t._v(" 和 "),s("code",[t._v(":/etc/mysql/conf.d")]),t._v("挂载出去")]),t._v(" "),s("p",[t._v("Mysql 容器启动时还需要指定 Root 用户密码，因此我们还要 配置一个环境变量 "),s("code",[t._v("MYSQL_ROOT_PASSWORD")])]),t._v(" "),s("h3",{attrs:{id:"_2-2、-mysql-示例配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2、-mysql-示例配置"}},[t._v("#")]),t._v(" 2.2、 Mysql 示例配置")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("[client]\ndefault-character-set=utf8mb4\n \n[mysql]\ndefault-character-set=utf8mb4\n \n[mysqld]\ninit_connect='SET collation_connection = utf8mb4_unicode_ci'\ninit_connect='SET NAMES utf8mb4'\ncharacter-set-server=utf8mb4\nlower-case-table-names=1\ncollation-server=utf8mb4_unicode_ci\nskip-character-set-client-handshake\nskip-name-resolve\n")])])]),s("h3",{attrs:{id:"_2-3、-部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3、-部署"}},[t._v("#")]),t._v(" 2.3、 部署")]),t._v(" "),s("ol",[s("li",[t._v("创建存储卷，用于存储Mysql 的数据")])]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516161834370.png",alt:"image-20220516161834370"}})]),t._v(" "),s("p",[t._v("设置存储卷名称，下一步")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516161938170.png",alt:"image-20220516161938170"}})]),t._v(" "),s("p",[t._v("配置创建方式，存储类型使用kubesphere安装的默认类型，访问模式配置单节点读写，容量设置1G测试用，下一步，高级设置没啥配置的直接完成即可。")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516162044879.png",alt:"image-20220516162044879"}})]),t._v(" "),s("p",[t._v("列表中显示了刚刚创建的存储卷，状态为未挂载：")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516162535936.png",alt:"image-20220516162535936"}})]),t._v(" "),s("ol",{attrs:{start:"2"}},[s("li",[t._v("创建配置字典（Configmap），用于挂载Mysql 的配置文件")])]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516162630117.png",alt:"image-20220516162630117"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516162655559.png",alt:"image-20220516162655559"}})]),t._v(" "),s("p",[t._v("key 为my.cnf，value 为上述示例配置，创建完成")]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),s("p",[t._v("键的名称必须要和实际配置的文件名称一样，最终在pod中生成的就是以key为文件名，值为文件内容的配置文件")])]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516162828368.png",alt:"image-20220516162828368"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516163128222.png",alt:"image-20220516163128222"}})]),t._v(" "),s("ol",{attrs:{start:"3"}},[s("li",[t._v("创建有状态副本集")])]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516160324498.png",alt:"image-20220516160324498"}})]),t._v(" "),s("p",[t._v("输入基本信息：名称，下一步")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516160439127.png",alt:"image-20220516160439127"}})]),t._v(" "),s("p",[t._v("容器组设置：输入"),s("code",[t._v("mysql:5.7.38")]),t._v("，会自动从docker.hub中查询对应的镜像，配置端口暴露，我们直接使用默认端口，自动填充端口设置信息，资源限制我这里不预留，一般生产环境要设置的")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516160556557.png",alt:"image-20220516160556557"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516160850321.png",alt:"image-20220516160850321"}})]),t._v(" "),s("p",[t._v("继续配置Root登录密码的环境变量，并勾选同步时区，保存并点击下一步：")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516161114050.png",alt:"image-20220516161114050"}})]),t._v(" "),s("p",[t._v("配置存储卷，选择我们上面创建的mysql-pvc存储卷和mysql-conf 配置")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516161337051.png",alt:"image-20220516161337051"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516163502823.png",alt:"image-20220516163502823"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516163544861.png",alt:"image-20220516163544861"}})]),t._v(" "),s("p",[t._v("最终的存储卷配置：下一步")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516163623932.png",alt:"image-20220516163623932"}})]),t._v(" "),s("p",[t._v("这步没啥配置的，直接创建")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516163706890.png",alt:"image-20220516163706890"}})]),t._v(" "),s("p",[t._v("然后就能在有状态副本集和服务中看见我们新建的mysql信息了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516163844508.png",alt:"image-20220516163844508"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516163911729.png",alt:"image-20220516163911729"}})]),t._v(" "),s("ol",{attrs:{start:"4"}},[s("li",[t._v("配置 mysql 外部访问")])]),t._v(" "),s("p",[t._v("上面通过创建工作负载生成的服务试headless服务，是无法外部访问的，为了能够外网访问，我们把它生成的服务删掉，自己通过指定工作负载的范式创建一个服务，通过NodePort 方式在节点上暴露个访问端口：")]),t._v(" "),s("p",[t._v("注意删除的时候不能把mysql 的有状态副本集也删掉了")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516164430746.png",alt:"image-20220516164430746"}})]),t._v(" "),s("p",[t._v("选择根据指定工作负载创建，")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516164503704.png",alt:"image-20220516164503704"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516164538672.png",alt:"image-20220516164538672"}})]),t._v(" "),s("p",[t._v("选择虚拟IP地址")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516164608075.png",alt:"image-20220516164608075"}})]),t._v(" "),s("p",[t._v("指定工作负载：选择我们创建的mysql")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516164638765.png",alt:"image-20220516164638765"}})]),t._v(" "),s("p",[t._v("配置端口信息：")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516164753351.png",alt:"image-20220516164753351"}})]),t._v(" "),s("p",[t._v("勾选外部访问，选择访问模式：NodePort")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516164816982.png",alt:"image-20220516164816982"}})]),t._v(" "),s("p",[t._v("之后就可以根据"),s("code",[t._v("节点Ip：32519")]),t._v("访问数据库了")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://img.zhoubg.cn/static/image-20220516164855542.png",alt:"image-20220516164855542"}})]),t._v(" "),s("p",[t._v("测试一下：success")]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"http://img.zhoubg.cn/static/image-20220516165126307.png",alt:"image-20220516165126307"}})])}),[],!1,null,null,null);a.default=e.exports}}]);